
#include "stm32f0xx.h"
#include "main.h"
#include "flash_if.h"

tag_flash_info_t tag_info;

pFunction Jump_To_Application;
void  Delay (uint32_t nCount);
void SysTick_Init(void);


#define GUI_DATA_IN_BOOT


uint8 program_move(uint16 crc)
{ uint16 app_crc;
	uint16 cmp = 2;
	int t = 0;
	uint32_t addr_src = APP_ERCODE_ADDRESS;
	uint32_t addr_dst = APPLICATION_ADDRESS;
	
  FLASH_If_Init();
	FLASH_If_Erase(APPLICATION_ADDRESS);
	FLASH_If_Write((__IO uint32_t* )&addr_dst, (uint32_t*)addr_src ,(0x400/4*28));
	FLASH_Lock();
	app_crc = cal_crc16((uint8*)APPLICATION_ADDRESS, 0x400*28);
	if(crc == app_crc) return 0;
	return 1;
}
	uint16 software_crc_get = 0;
int main(void)
{
  
	uint32_t JumpAddress = 0;
	
	SysTick_Init();

	memcpy((uint8*)&tag_info.net_flag_set,  (void*)STORE_SYS_INFO_PAGE_ADDR, sizeof(tag_flash_info_t));
#ifdef QRCODE
	/*check if qrcode can be gernerate*/
	if(tag_info.qr_set_flag == SYS_PARA_MAGIC_NUM && tag_info.qr_crc != cal_crc16(&tag_info.qrcode[0], 63))
	{
		if (((*(__IO uint32_t*)APP_ERCODE_ADDRESS) & 0x2FFE0000 ) == 0x20000000)
    { 
      /* Jump to user application */
      JumpAddress = *(__IO uint32_t*) (APP_ERCODE_ADDRESS + 4);
      Jump_To_Application = (pFunction) JumpAddress;
      
      /* Initialize user application's Stack Pointer */
      __set_MSP(*(__IO uint32_t*) APP_ERCODE_ADDRESS);
      
      /* Jump to application */
      Jump_To_Application();
    }
  }
#endif
	
	/*check if soft update flag is set*/
	if(SYS_PARA_MAGIC_NUM == tag_info.update_software_flag)
	{
		software_crc_get =  cal_crc16((uint8*)APP_ERCODE_ADDRESS, 0x400*28);
		if(tag_info.software_crc == software_crc_get)
		{
		 if(1 == program_move(tag_info.software_crc))
		 {
				while(1)
				{
					//error update
				}
		 }
		}
	}
	
	if (((*(__IO uint32_t*)APPLICATION_ADDRESS) & 0x2FFE0000 ) == 0x20000000)
    { 
      /* Jump to user application */
      JumpAddress = *(__IO uint32_t*) (APPLICATION_ADDRESS + 4);
      Jump_To_Application = (pFunction) JumpAddress;
      
      /* Initialize user application's Stack Pointer */
      __set_MSP(*(__IO uint32_t*) APPLICATION_ADDRESS);
      
      /* Jump to application */
      Jump_To_Application();
    }
		
}


void  Delay (uint32_t nCount)
{
  for(; nCount != 0; nCount--);
}


void SysTick_Init(void)
{
  if(SysTick_Config(SystemCoreClock/1000))
	{
    while(1);
  }
}


#ifdef GUI_DATA_IN_BOOT

const uint8_t logo[1024] __attribute__((at(0x08000800)))          = {
//ÁªÊ¤¿Æ¼¼
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0xC0,0xC0,0xC0,0xC0,
0xC0,0xC0,0xC0,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0xC0,
0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x80,0x80,0x80,0x00,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x80,0xE0,0xF0,0xF8,0x3C,0x1E,0x0F,0x07,0x07,0x83,0xC3,0xC1,0xE1,0xE1,0xE1,
0xE1,0xE1,0xC1,0xC3,0x83,0x07,0x07,0x0F,0x1E,0x3C,0x18,0x00,0x00,0x00,0x00,0x01,
0xFF,0xFF,0xFF,0x31,0x31,0xFF,0xFF,0x01,0x19,0x19,0x1F,0x1F,0xFA,0xF8,0xFE,0x1F,
0x1F,0x19,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0xFC,0xFC,0xFC,0x64,0x64,0x64,0xE4,
0xE4,0xE4,0x04,0x1F,0xFF,0xFF,0xC4,0xC6,0xE7,0x75,0x35,0x04,0x04,0x00,0x00,0x00,
0x40,0x42,0x42,0x43,0xC3,0xFF,0xFF,0x41,0x41,0x41,0x41,0x80,0x86,0x8E,0x3C,0x38,
0x10,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x10,0x10,0xFF,0xFF,0x10,
0x18,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0xFF,0xFF,0xFF,0x0C,0x0C,0x0C,0x0C,0x0C,0x00,
0xFC,0xFF,0xFF,0x03,0x00,0x00,0x00,0xF8,0xFE,0xFF,0x07,0x03,0x01,0x00,0x00,0x00,
0x00,0x00,0x01,0x03,0x07,0xFF,0xFE,0xF8,0x70,0x70,0x70,0x70,0x70,0x70,0x80,0x80,
0xFF,0xFF,0xFF,0xC4,0xC4,0xFF,0xFF,0x60,0x64,0x04,0x84,0xE4,0xFF,0x7F,0xFF,0xF4,
0xC4,0x04,0x04,0x04,0x00,0x00,0x00,0x10,0x1C,0x1F,0xEF,0xE3,0xE0,0x2C,0x2C,0xEF,
0xEF,0xEB,0x2C,0xEC,0xEE,0xE7,0x27,0x2F,0xEE,0xFC,0xF8,0x1E,0x1E,0x04,0x00,0x00,
0x80,0xE0,0xF0,0x7C,0x1F,0xFF,0xFF,0x02,0x16,0x7E,0x6C,0x60,0x61,0x23,0x37,0x36,
0x30,0xFF,0xFF,0xFF,0x18,0x18,0x18,0x00,0x00,0x08,0x18,0x1C,0x0C,0xFF,0xFF,0x07,
0x03,0x03,0x01,0x01,0x0F,0x3F,0xFD,0xE1,0xC1,0xE1,0xFD,0x3F,0x0F,0x03,0x00,0x00,
0x01,0x0F,0x3F,0x7E,0xF8,0xE0,0xC0,0x80,0x03,0x07,0x0F,0x1E,0x1C,0x38,0x38,0x38,
0x38,0x38,0x1C,0x1E,0x0F,0x07,0x03,0x80,0xC0,0xE0,0xC0,0x00,0x00,0x00,0x01,0x01,
0x01,0x01,0x00,0x00,0x10,0x1F,0x1F,0x00,0x0C,0x0E,0x0F,0x07,0x01,0x00,0x00,0x01,
0x03,0x07,0x0E,0x0E,0x04,0x00,0x00,0x0C,0x0C,0x0C,0x0F,0x0F,0x0F,0x0C,0x0C,0x0F,
0x0F,0x0F,0x0C,0x0F,0x0F,0x0F,0x0C,0x0C,0x0F,0x0F,0x0F,0x6C,0x6C,0x0C,0x00,0x00,
0x00,0x01,0x01,0x00,0x00,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x0F,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x0C,0x0C,0x0F,0x0F,0x00,
0x04,0x0C,0x0C,0x0C,0x06,0x06,0x07,0x03,0x03,0x03,0x07,0x06,0x0E,0x0C,0x0C,0x0C,
0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x07,0x0F,0x0E,0x0E,0x1C,0x1C,0x1C,0x1C,
0x1C,0x1C,0x1C,0x0E,0x0E,0x0F,0x07,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x1F,0x61,
0x18,0x07,0x18,0x61,0x1F,0x01,0x1F,0x61,0x18,0x07,0x18,0x61,0x1F,0x01,0x1F,0x61,
0x18,0x07,0x18,0x61,0x1F,0x01,0x60,0x60,0x00,0x00,0x01,0x3F,0x40,0x40,0x21,0x7F,
0x40,0x41,0x7F,0x42,0x01,0x01,0x41,0x7E,0x40,0x00,0x41,0x41,0x7F,0x40,0x40,0x66,
0x49,0x49,0x49,0x49,0x33,0x00,0x01,0x3F,0x40,0x40,0x40,0x21,0x7F,0x40,0x41,0x7F,
0x42,0x01,0x41,0x7E,0x40,0x00,0xD6,0x29,0x29,0x29,0x27,0xC1,0x00,0x60,0x60,0x00,
0x00,0x1C,0x22,0x41,0x41,0x22,0x00,0x41,0x7F,0x42,0x01,0x01,0x41,0x7E,0x40,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
const uint8_t logo1[2010] __attribute__((at(0x08000C00)))          = {
/*-- 0 A  --*/
 0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20,
/*-- 1 B  --*/
 0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00,
/*-- 2 C  --*/
 0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00,
/*-- 3 D  --*/
 0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00,
/*-- 4 E  --*/
 0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00,
/*-- 5 F  --*/
 0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00,
/*-- 6 G  --*/
 0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00,
/*-- 7 H  --*/
 0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20,
/*-- 8 I  --*/
 0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,
/*-- 9 J  --*/
 0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00,
/*--10 K  --*/
 0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00,
/*--11 L  --*/
 0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00,
/*--12 M  --*/
 0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x00,0x3F,0x00,0x3F,0x20,0x00,
/*--13 N  --*/
 0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00,
/*--14 O  --*/
 0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00,
/*--15 P  --*/
 0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00,
/*--16 Q  --*/
 0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00,
/*--17 R  --*/
 0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20,
/*--18 S  --*/
 0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00,
/*--19 T  --*/
 0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,
/*--20 U  --*/
 0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,
/*--21 V  --*/
 0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00,
/*--22 W  --*/
 0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00,
/*--23 X  --*/
 0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20,
/*--24 Y  --*/
 0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,
/*--25 Z  --*/
 0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00,
/*--  0  --*/
 0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,
/*--  1  --*/
 0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,
/*--  2  --*/
 0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,
/*--  3  --*/
 0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00,
/*--  4  --*/
 0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00,
/*--  5  --*/
 0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00,
/*--  6  --*/
 0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00,
/*--  7  --*/
 0x00,0x38,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,
/*--  8  --*/
 0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,
/*--  9  --*/
 0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x00,0x31,0x22,0x22,0x11,0x0F,0x00,
/*--  -  --*/
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
/*--  .  --*/
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,
//0Íø
 0x00,0xFE,0x02,0x12,0x22,0xC2,0x22,0x1A,0x22,0x42,0x82,0x72,0x22,0xFE,0x00,0x00,
 0x00,0x7F,0x08,0x04,0x03,0x00,0x03,0x0C,0x04,0x02,0x01,0x26,0x60,0x3F,0x00,0x00,
//1Âç
 0x20,0x38,0xA7,0x62,0x30,0x00,0x10,0x08,0x9F,0x64,0x64,0x94,0x0C,0x00,0x00,0x00,
 0x22,0x23,0x12,0x12,0x12,0x04,0x02,0x7F,0x22,0x22,0x22,0x22,0x7F,0x03,0x02,0x00,
//2Î´
 0x40,0x40,0x48,0x48,0x48,0x48,0xC8,0xFF,0x48,0x48,0x48,0x48,0x48,0x40,0x40,0x00,
 0x20,0x20,0x10,0x10,0x08,0x06,0x01,0xFF,0x01,0x02,0x04,0x08,0x18,0x30,0x10,0x00,
//3Á¬
 0x40,0x41,0x4E,0xC4,0x00,0x44,0xE4,0x5C,0x47,0xF4,0x44,0x44,0x44,0x04,0x00,0x00,
 0x00,0x40,0x20,0x1F,0x22,0x42,0x42,0x42,0x42,0x5F,0x42,0x42,0x42,0x42,0x42,0x00,
//4½Ó
 0x08,0x08,0x08,0xFF,0x88,0x68,0x24,0x2C,0xB4,0x25,0x26,0x34,0x2C,0x24,0x20,0x00,
 0x02,0x42,0x81,0x7F,0x02,0x82,0x8A,0x4E,0x53,0x32,0x12,0x2E,0x42,0xC2,0x02,0x00,
//5ÖÐ
 0x00,0x00,0xFC,0x08,0x08,0x08,0x08,0xFF,0x08,0x08,0x08,0x08,0xFC,0x08,0x00,0x00,
 0x00,0x00,0x07,0x02,0x02,0x02,0x02,0xFF,0x02,0x02,0x02,0x02,0x07,0x00,0x00,0x00,
//6ÒÑ
 0x00,0x00,0xE2,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x7E,0x00,0x00,0x00,0x00,
 0x00,0x00,0x3F,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3C,0x10,0x00,
//7×Ô
0x00,0x00,0x00,0xF8,0x48,0x48,0x4C,0x4B,0x4A,0x48,0x48,0x48,0xF8,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0xFF,0x00,0x00,0x00,
//8¼ì
0x08,0x88,0x68,0xFF,0x28,0x48,0x10,0x48,0x44,0x43,0x44,0x48,0x50,0x10,0x10,0x00,
0x02,0x01,0x00,0x7F,0x00,0x20,0x22,0x2C,0x21,0x2E,0x30,0x28,0x27,0x22,0x20,0x00
};

#endif




